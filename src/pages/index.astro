---
import Footer from '../components/Footer.astro'
import Header from '../components/Header.astro'
import Items from '../components/Items.astro'
import Layout from '../layouts/Layout.astro'
---

<Layout>
  <Header />
  <Items />
  <Footer />
</Layout>

<script>
  const softUpdate = async () => {
    const update = await fetch('/api/update-feeds').then((r) => r.json())
    if (!update.ok || update.added === 0) {
      return
    }

    const html = await fetch('/partial').then((r) => r.text())

    const nextDoc = new DOMParser().parseFromString(html, 'text/html')
    const nextFeed = nextDoc.querySelector('#root')
    const curFeed = document.querySelector('#root')

    if (!curFeed || !nextFeed) {
      return
    }

    const swap = () => {
      curFeed.innerHTML = nextFeed.innerHTML
    }

    if (document.startViewTransition) {
      document.startViewTransition(swap)
    } else {
      swap()
    }
  }

  softUpdate()
</script>
